name: Build Ares Plugin

on:
  push:
    branches: [ main, master, develop, dev-peru, feature/**, bugfix/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read   # mÃ­nimo necesario

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'   # cache integrado de setup-java (opcional pero Ãºtil)

      # Cache adicional para wrapper/caches (acciÃ³n oficial de GitHub)
      - name: ğŸ—‚ï¸ Cache Gradle directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ” Ensure Gradle Wrapper
        run: |
          echo "ğŸ”§ Ensuring Gradle Wrapper..."
          if [ ! -f "gradlew" ]; then
            echo "âŒ gradlew not found. Please commit the Gradle wrapper to the repo."
            exit 1
          fi
          chmod +x gradlew
          # Garantiza el jar del wrapper (por si algÃºn repo lo omite)
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "ğŸ“¥ Downloading gradle-wrapper.jar..."
            mkdir -p gradle/wrapper
            curl -sSL -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.10.0/gradle/wrapper/gradle-wrapper.jar
          fi

      - name: ğŸ“š Check libs directory
        run: |
          echo "ğŸ“ Checking libs directory..."
          if [ -d "libs" ]; then
            echo "âœ… libs exists. Listing up to 10 jars:"
            find libs -name "*.jar" | head -10 || true
            echo "Total JARs: $(find libs -name "*.jar" | wc -l)"
          else
            echo "âš ï¸ libs missing; creating empty structure so compilation won't break on path checks."
            mkdir -p libs/{abilities,clients,holograms,pearls,placeholders,ranks,spigots}
            touch libs/Vault.jar
            touch libs/ViaVersion.jar
            touch libs/ProtocolSupport.jar
            touch libs/holograms/HolographicDisplays.jar
            touch libs/clients/CheatBreakerAPI.jar
            touch libs/abilities/PandaAbilityAPI.jar
            touch libs/pearls/VortexPearlsAPI.jar
            touch libs/placeholders/PlaceholderAPI.jar
            touch libs/spigots/1.8.8.jar
            touch libs/spigots/1.16.jar
            touch libs/spigots/1.7.10.jar
            touch libs/spigots/1.17.jar
            for jar in AquaCoreAPI Zoot VolcanoAPI ZoomAPI MizuAPI AtomAPI CoreAPI zPermissions HestiaAPI pxAPI Alchemist Holiday Akuma Helium DeluxeTags; do
              touch "libs/ranks/${jar}.jar"
            done
          fi

      - name: ğŸ”¨ Build with Gradle
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx2g'"
        run: |
          echo "ğŸš€ Building Ares plugin..."
          ./gradlew --version
          ./gradlew clean shadowJar --no-daemon --stacktrace

      - name: ğŸ“Š Build info
        run: |
          echo "ğŸ“‹ Build Information:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f "build.gradle.kts" ]; then
            echo "ğŸ—ï¸  Project group: $(grep '^group' build.gradle.kts | head -n1 | cut -d'"' -f2 || true)"
          fi
          echo "ğŸ“… Date: $(date +'%d.%m.%Y %H:%M:%S')"
          echo "ğŸ¯ Java: $(java -version 2>&1 | head -n1)"
          echo "âš™ï¸  Gradle: $(./gradlew --version | grep '^Gradle ' | head -n1)"
          if [ -d "build/libs" ]; then
            echo "ğŸ“¦ Generated JARs:"
            ls -la build/libs/*.jar || echo "No JAR files found"
          fi

      - name: ğŸ¯ Upload JAR Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Ares-Plugin-${{ github.run_number }}
          path: build/libs/*-all.jar
          retention-days: 30

      - name: ğŸ“ˆ Upload build reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports-${{ github.run_number }}
          path: build/reports/
          retention-days: 7

      - name: âœ… Build Success Notification
        if: success()
        run: |
          echo "ğŸ‰ BUILD SUCCESSFUL!"
          echo "âœ… JAR artifact uploaded."

      - name: âŒ Build Failure Notification
        if: failure()
        run: |
          echo "ğŸ’¥ BUILD FAILED!"
          echo "ğŸ” Check the 'build-reports' artifact and logs above."
